<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Staff Profile</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header class="topbar">
      <a href="admin.html" class="logo">‚Üê Back</a>
      <div class="brand">Staff Profile</div>
    </header>

    <main class="container">
      <section class="panel">
        <h2 id="staffName"></h2>
        <p><strong>Email:</strong> <span id="staffEmail"></span></p>
        <p><strong>Role:</strong> <span id="staffRole"></span></p>
      </section>

      <!-- Strikes -->
      <section class="panel">
        <h3>Strikes</h3>
        <form id="strikeForm" style="display: flex; gap: 10px; flex-wrap: wrap">
          <input
            type="text"
            id="strikeReason"
            placeholder="Reason for strike"
            required
          />
          <button type="submit">Add Strike</button>
        </form>
        <table class="table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Reason</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="strikesBody"></tbody>
        </table>
      </section>

      <!-- Comments -->
      <section class="panel">
        <h3>Comments</h3>
        <form
          id="commentForm"
          style="display: flex; gap: 10px; flex-wrap: wrap"
        >
          <input
            type="text"
            id="commentText"
            placeholder="Write a comment..."
            required
          />
          <button type="submit">Add Comment</button>
        </form>
        <ul id="commentsList"></ul>
      </section>
    </main>

    <script>
      const token = localStorage.getItem("token");
      const apiBase = "/.netlify/functions";
      const urlParams = new URLSearchParams(window.location.search);
      const username = urlParams.get("username");

      async function loadStaffProfile() {
        const res = await fetch(
          `${apiBase}/getUserProfile?username=${encodeURIComponent(username)}`,
          {
            headers: { Authorization: `Bearer ${token}` },
          }
        );
        if (!res.ok) {
          alert("Failed to load profile");
          return;
        }
        const data = await res.json();

        document.getElementById("staffName").textContent = data.username;
        document.getElementById("staffEmail").textContent = data.email;
        document.getElementById("staffRole").textContent = data.role;

        populateStrikes(data.strikes || []);
        populateComments(data.comments || []);
      }

      function populateStrikes(strikes) {
        const tbody = document.getElementById("strikesBody");
        tbody.innerHTML = "";
        strikes.forEach((s) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
          <td>${new Date(s.date).toLocaleString()}</td>
          <td>${s.reason}</td>
          <td><button onclick="deleteStrike('${s._id}')">Remove</button></td>
        `;
          tbody.appendChild(tr);
        });
      }

      function populateComments(comments) {
        const ul = document.getElementById("commentsList");
        ul.innerHTML = "";
        comments.forEach((c) => {
          const li = document.createElement("li");
          li.textContent = `${new Date(c.date).toLocaleString()}: ${c.text}`;
          ul.appendChild(li);
        });
      }

      // Add strike
      document
        .getElementById("strikeForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const reason = document.getElementById("strikeReason").value;
          const res = await fetch(`${apiBase}/addStrike`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ username, reason }),
          });
          if (res.ok) {
            alert("Strike added");
            document.getElementById("strikeReason").value = "";
            loadStaffProfile();
          }
        });

      // Delete strike
      async function deleteStrike(strikeId) {
        if (!confirm("Remove this strike?")) return;
        await fetch(`${apiBase}/deleteStrike`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ username, strikeId }),
        });
        loadStaffProfile();
      }

      // Add comment
      document
        .getElementById("commentForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const text = document.getElementById("commentText").value;
          await fetch(`${apiBase}/addComment`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ username, text }),
          });
          document.getElementById("commentText").value = "";
          loadStaffProfile();
        });

      loadStaffProfile();
    </script>
  </body>
</html>
