<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Patient Details — NHS Staff Portal</title>
    <link rel="stylesheet" href="style.css" />
    <meta
      name="description"
      content="Prince Georges University Hospital — Official Roblox Prince Georges Hospital | Apart of the National Health Service"
    />

    <meta property="og:title" content="Prince Georges University Hospital" />
    <meta
      property="og:description"
      content="Official Roblox Prince Georges Hospital | Apart of the National Health Service"
    />
    <meta
      property="og:image"
      content="https://princegeorgesuniversityhospital.netlify.app/Assets/logo.png"
    />
    <meta property="og:type" content="website" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Prince Georges University Hospital" />
    <meta
      name="twitter:description"
      content="Official Roblox Prince Georges Hospital | Apart of the National Health Service"
    />
    <meta
      name="twitter:image"
      content="https://princegeorgesuniversityhospital.netlify.app/Assets/logo.png"
    />
    <style>
      /* Replacing inline fieldset styles */
      form fieldset {
        border: 1px solid #ccc;
        padding: 12px;
        margin-bottom: 16px;
      }

      /* CARE TEAM Section margin tweak (was 1px inline) */
      form fieldset.care-team {
        margin-bottom: 1px;
      }
    </style>
  </head>
  <body>
    <header class="topbar">
      <div class="brand">
        <a href="index.html" style="color: inherit; text-decoration: none"
          >NHS Staff Portal</a
        >
        <nav class="topnav">
          <a href="index.html">Home</a>
          <a href="cadmin.html">CAdmin</a>
          <a href="careers.html">Careers</a>
          <a href="admin.html">Admin</a>
        </nav>
      </div>
      <div class="meta" id="metaArea"></div>
    </header>

    <main class="container" id="mainContainer">
      <section id="patientDetails" class="panel">
        <h2 id="patientName">Loading...</h2>

        <!-- New summary vertical layout -->
        <div id="patientSummary">
          <!-- Filled by JS -->
        </div>

        <h3>Medical History</h3>
        <ul id="medicalHistoryList"></ul>

        <h3>Add Clinical Information</h3>
        <form id="clinicalInfoForm" class="form">
          <!-- TRIAGE Section -->
          <fieldset>
            <legend><strong>TRIAGE Section</strong></legend>
            <label
              >ED Location:
              <input type="text" id="inputEdLocation" />
            </label>
            <label
              >Allergies:
              <input type="text" id="inputAllergies" />
            </label>
            <label
              >Triage Time:
              <input type="datetime-local" id="inputTriageTime" />
            </label>
          </fieldset>

          <!-- CARE TEAM Section -->
          <fieldset class="care-team">
            <legend><strong>CARE TEAM Section</strong> (optional)</legend>
            <label
              >Nurse:
              <input type="text" id="inputNurse" />
            </label>
            <label
              >Overseeing Clinician:
              <input type="text" id="inputOverseeingClinician" />
            </label>
            <label
              >Direct Clinician:
              <input type="text" id="inputDirectClinician" />
            </label>
            <label
              >Specialist Clinician:
              <input type="text" id="inputSpecialistClinician" />
            </label>
            <label
              >Pharmacist:
              <input type="text" id="inputPharmacist" />
            </label>
            <label
              >CCOT:
              <input type="text" id="inputCCOT" />
            </label>
            <label
              >Consulting Speciality:
              <input type="text" id="inputConsultingSpeciality" />
            </label>
            <label
              >Admitting Speciality:
              <input type="text" id="inputAdmittingSpeciality" />
            </label>
          </fieldset>

          <!-- LATEST OBSERVATIONS -->
          <fieldset class="latest-observations">
            <legend><strong>LATEST OBSERVATIONS ()</strong></legend>

            <label>
              NEWS2 SCORE:
              <select id="inputNews2Score">
                <option value="">Select Score</option>
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
              </select>
            </label>
            <label>
              HR (Heart Rate):
              <input type="number" id="inputHeartRate" min="0" />
            </label>
            <label>
              BP (Blood Pressure):
              <input type="text" id="inputBloodPressure" />
            </label>
            <label>
              SpO2 (Blood Oxygen):
              <input type="number" id="inputSpO2" min="0" max="100" />
            </label>
            <label>
              RR (Respiratory Rate):
              <input type="number" id="inputRespiratoryRate" min="0" />
            </label>
            <label>
              Temperature:
              <input type="number" id="inputTemperature" step="0.1" />
            </label>
            <label>
              AVPU:
              <input type="text" id="inputAVPU" />
            </label>
            <label>
              GCS:
              <input type="text" id="inputGCS" />
            </label>

            <!-- Image is now properly inside the same fieldset -->
            <div
              style="
                grid-column: 1 / -1;
                text-align: center;
                margin: 30px auto 0 auto;
              "
            >
              <img
                id="news2Chart"
                src="./Assets/NEWS2chart.png"
                alt="NEWS2 Chart"
                style="
                  width: 100%;
                  max-width: 1000px;
                  height: auto;
                  cursor: auto;
                "
              />
            </div>
          </fieldset>

          <!-- OTHER DETAILS -->
          <fieldset>
            <legend><strong>OTHER DETAILS</strong></legend>
            <label
              >Presenting Complaint?
              <textarea id="inputPresentingComplaint" rows="2"></textarea>
            </label>
            <label
              >History of presenting complaint?
              <textarea
                id="inputHistoryPresentingComplaint"
                rows="2"
              ></textarea>
            </label>
            <label
              >Past Medical History?
              <textarea id="inputPastMedicalHistory" rows="2"></textarea>
            </label>
            <label
              >Current Medications?
              <textarea id="inputCurrentMedications" rows="2"></textarea>
            </label>
            <label
              >Differential Diagnosis
              <textarea id="inputDifferentialDiagnosis" rows="2"></textarea>
            </label>
          </fieldset>

          <!-- DISCHARGE LOGS -->
          <fieldset>
            <legend><strong>DISCHARGE LOGS</strong></legend>
            <label
              >Who discharged:
              <input type="text" id="inputWhoDischarged" />
            </label>
            <label
              >Time of discharge:
              <input type="datetime-local" id="inputTimeDischarge" />
            </label>
            <label
              >Outcome of patient:
              <textarea id="inputOutcomePatient" rows="2"></textarea>
            </label>
          </fieldset>

          <div class="form-actions">
            <button id="saveClinicalBtn" type="button">
              Save Clinical Info
            </button>
          </div>
          <div class="form-actions" style="margin-top: 10px">
            <button id="exportPdfBtn" type="button">
              Export Medical History as PDF
            </button>
          </div>
        </form>

        <div id="statusMsg"></div>
      </section>
    </main>

    <footer class="footer">
      Copyright 2025 © Prince George University Hospital
    </footer>
    <footer class="footer">
      This website is not an official National Health Service website, this is
      just for roleplay purposes and do not intend for real life usage.
    </footer>

    <script src="app.js"></script>

    <script>
      function calculateAge(dobString) {
        if (!dobString) return "—";
        const dob = new Date(dobString);
        const now = new Date();
        let age = now.getFullYear() - dob.getFullYear();
        const m = now.getMonth() - dob.getMonth();
        if (m < 0 || (m === 0 && now.getDate() < dob.getDate())) {
          age--;
        }
        return age;
      }

      window.api = {
        async getPatient(id, token) {
          if (!token) throw new Error("No auth token found");
          const res = await fetch(
            `/.netlify/functions/getPatientById?id=${id}`,
            {
              method: "GET",
              headers: { Authorization: `Bearer ${token}` },
            }
          );
          if (!res.ok)
            throw new Error(`Error fetching patient: ${res.statusText}`);
          return res.json();
        },

        async getLatestMedicalHistory(id, token) {
          if (!token) throw new Error("No auth token found");
          const res = await fetch(
            `/.netlify/functions/getLatestMedicalHistory?id=${id}`,
            {
              method: "GET",
              headers: { Authorization: `Bearer ${token}` },
            }
          );
          if (!res.ok)
            throw new Error(
              `Error fetching latest medical history: ${res.statusText}`
            );
          return res.json();
        },

        async addPatientRecord(id, record, token) {
          if (!token) throw new Error("No auth token found");
          const res = await fetch(`/.netlify/functions/addPatientRecord`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ id, ...record }),
          });
          if (res.status === 401) {
            alert("Session expired or unauthorized. Please log in again.");
            window.location.href = "index.html";
            return;
          }
          if (!res.ok) {
            const text = await res.text();
            throw new Error(`Failed to save clinical record: ${text}`);
          }
          return res.json();
        },
      };

      (async () => {
        const token = localStorage.getItem("token");
        if (!token) {
          alert("Please log in first");
          window.location.href = "index.html";
          return;
        }

        const metaArea = document.getElementById("metaArea");
        metaArea.textContent = `Logged in as ${localStorage.getItem(
          "username"
        )}`;

        const urlParams = new URLSearchParams(window.location.search);
        const patientId = urlParams.get("id");
        if (!patientId) {
          alert("No patient ID provided");
          window.location.href = "index.html";
          return;
        }

        let patient;
        try {
          patient = await window.api.getPatient(patientId, token);
        } catch (e) {
          alert("Failed to load patient: " + e.message);
          window.location.href = "index.html";
          return;
        }

        document.getElementById("patientName").textContent = patient.name;

        // Fill the new summary vertical layout
        const summaryDiv = document.getElementById("patientSummary");
        summaryDiv.innerHTML = `
      <p><strong>Roblox Name:</strong> ${patient.robloxName || "—"}</p>
      <p><strong>Date of Birth:</strong> ${
        patient.dateOfBirth
          ? new Date(patient.dateOfBirth).toLocaleDateString()
          : "—"
      }</p>
      <p><strong>Age:</strong> ${calculateAge(patient.dateOfBirth)}</p>
      <p><strong>Patient ID:</strong> ${patient.patientId || "—"}</p>
      <p><strong>Priority:</strong> ${
        patient.priority !== undefined ? patient.priority : "—"
      }</p>
      <p><strong>Presenting Complaint:</strong> ${
        patient.presentingComplaint || "—"
      }</p>
    `;

        // Fill medical history list
        const histList = document.getElementById("medicalHistoryList");
        histList.innerHTML = "";
        (patient.medicalHistory || []).forEach((item) => {
          const li = document.createElement("li");
          let text = "";
          if (typeof item === "string") text = item;
          else {
            if (item.createdAt)
              text += `Date: ${new Date(item.createdAt).toLocaleString()}\n`;
            if (item.triage) text += `Triage: ${item.triage}\n`;
            if (item.primarySurvey)
              text += `Primary Survey: ${item.primarySurvey}\n`;
            if (item.news2Record) text += `NEWS2: ${item.news2Record}\n`;
          }
          li.textContent = text;
          histList.appendChild(li);
        });

        // Load latest medical history and autofill inputs
        try {
          const latest = await window.api.getLatestMedicalHistory(
            patientId,
            token
          );
          Object.entries(latest).forEach(([key, value]) => {
            const el = document.getElementById(
              `input${key.charAt(0).toUpperCase()}${key.slice(1)}`
            );
            if (el) el.value = value || "";
          });
        } catch (e) {
          console.warn("Failed to load latest medical history:", e);
        }

        // Save clinical info button
        document.getElementById("saveClinicalBtn").onclick = async () => {
          const record = {};
          document
            .querySelectorAll(
              "#clinicalInfoForm input, #clinicalInfoForm textarea, #clinicalInfoForm select"
            )
            .forEach((el) => {
              const key = el.id.replace(/^input/, "");
              record[key.charAt(0).toLowerCase() + key.slice(1)] =
                el.value.trim() || null;
            });

          const hasAnyField = Object.values(record).some((v) => v !== null);
          if (!hasAnyField) {
            alert("Please fill at least one field before saving.");
            return;
          }

          try {
            await window.api.addPatientRecord(patientId, record, token);
            alert("Clinical info saved successfully!");
            window.location.reload();
          } catch (e) {
            alert("Failed to save clinical info: " + e.message);
          }
        };

        // Export Medical History CSV
        document
          .getElementById("exportMedicalHistoryBtn")
          ?.addEventListener("click", () => {
            const medicalHistory = patient.medicalHistory || [];
            const csvContent =
              "data:text/csv;charset=utf-8," +
              [
                [
                  "Created At",
                  "Created By",
                  "Triage",
                  "Primary Survey",
                  "NEWS2 Record",
                  "ED Location",
                  "Allergies",
                  "Triage Time",
                  "Nurse",
                  "Overseeing Clinician",
                  "Direct Clinician",
                  "Specialist Clinician",
                  "Pharmacist",
                  "CCOT",
                  "Consulting Speciality",
                  "Admitting Speciality",
                  "NEWS2 Score",
                  "Heart Rate",
                  "Blood Pressure",
                  "SpO2",
                  "Respiratory Rate",
                  "Temperature",
                  "AVPU",
                  "GCS",
                  "Presenting Complaint",
                  "History Presenting Complaint",
                  "Past Medical History",
                  "Current Medications",
                  "Differential Diagnosis",
                  "Who Discharged",
                  "Time Discharge",
                  "Outcome Patient",
                ],
                ...medicalHistory.map((rec) => [
                  rec.createdAt ? new Date(rec.createdAt).toLocaleString() : "",
                  rec.createdBy || "",
                  rec.triage || "",
                  rec.primarySurvey || "",
                  rec.news2Record || "",
                  rec.edLocation || "",
                  rec.allergies || "",
                  rec.triageTime || "",
                  rec.nurse || "",
                  rec.overseeingClinician || "",
                  rec.directClinician || "",
                  rec.specialistClinician || "",
                  rec.pharmacist || "",
                  rec.ccot || "",
                  rec.consultingSpeciality || "",
                  rec.admittingSpeciality || "",
                  rec.news2Score || "",
                  rec.heartRate || "",
                  rec.bloodPressure || "",
                  rec.spO2 || "",
                  rec.respiratoryRate || "",
                  rec.temperature || "",
                  rec.avpu || "",
                  rec.gcs || "",
                  rec.presentingComplaint || "",
                  rec.historyPresentingComplaint || "",
                  rec.pastMedicalHistory || "",
                  rec.currentMedications || "",
                  rec.differentialDiagnosis || "",
                  rec.whoDischarged || "",
                  rec.timeDischarge || "",
                  rec.outcomePatient || "",
                ]),
              ]
                .map((e) => e.join(","))
                .join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute(
              "download",
              `${patient.name.replace(/\s+/g, "_")}_medical_history.csv`
            );
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          });

        // Export PDF
        document
          .getElementById("exportPdfBtn")
          .addEventListener("click", () => {
            const element = document.body;
            let patientId = "UnknownID";
            const patientIdPara = Array.from(
              document.querySelectorAll("p")
            ).find((p) => p.textContent.includes("Patient ID:"));
            if (patientIdPara)
              patientId = patientIdPara.textContent
                .replace("Patient ID:", "")
                .trim();

            const header = document.querySelector("header.topbar");
            const saveBtnContainer =
              document.getElementById("saveClinicalBtn")?.parentNode;
            const exportBtnContainer =
              document.getElementById("exportPdfBtn")?.parentNode;
            const footers = document.querySelectorAll("footer.footer");
            if (header) header.style.display = "none";
            if (saveBtnContainer) saveBtnContainer.style.display = "none";
            if (exportBtnContainer) exportBtnContainer.style.display = "none";
            footers.forEach((f) => (f.style.display = "none"));

            html2pdf()
              .set({
                margin: 0.1,
                filename: `Patient(${patientId}).pdf`,
                image: { type: "jpeg", quality: 1 },
                html2canvas: {
                  scale: 4,
                  useCORS: true,
                  scrollX: 0,
                  scrollY: 0,
                  width: document.body.scrollWidth,
                  height: document.body.scrollHeight,
                },
                jsPDF: { unit: "in", format: "a4", orientation: "portrait" },
              })
              .from(element)
              .save()
              .then(() => {
                if (header) header.style.display = "";
                if (saveBtnContainer) saveBtnContainer.style.display = "";
                if (exportBtnContainer) exportBtnContainer.style.display = "";
                footers.forEach((f) => (f.style.display = ""));
              });
          });
      })();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
      document.getElementById("exportPdfBtn").addEventListener("click", () => {
        const element = document.body; // capture entire page

        // Find the Patient ID line
        let patientId = "UnknownID";
        const patientIdPara = Array.from(document.querySelectorAll("p")).find(
          (p) => p.textContent.includes("Patient ID:")
        );
        if (patientIdPara) {
          patientId = patientIdPara.textContent
            .replace("Patient ID:", "")
            .trim();
        }

        // Select elements to hide
        const header = document.querySelector("header.topbar");
        const saveBtnContainer =
          document.getElementById("saveClinicalBtn")?.parentNode;
        const exportBtnContainer =
          document.getElementById("exportPdfBtn")?.parentNode;
        const footers = document.querySelectorAll("footer.footer");

        // Temporarily hide elements
        if (header) header.style.display = "none";
        if (saveBtnContainer) saveBtnContainer.style.display = "none";
        if (exportBtnContainer) exportBtnContainer.style.display = "none";
        footers.forEach((f) => (f.style.display = "none"));

        const opt = {
          margin: 0.1,
          filename: `Patient(${patientId}).pdf`,
          image: { type: "jpeg", quality: 1 },
          html2canvas: {
            scale: 4,
            useCORS: true,
            scrollX: 0,
            scrollY: 0,
            width: document.body.scrollWidth,
            height: document.body.scrollHeight,
          },
          jsPDF: {
            unit: "in",
            format: "a4",
            orientation: "portrait",
          },
        };

        html2pdf()
          .set(opt)
          .from(element)
          .save()
          .then(() => {
            // Restore hidden elements
            if (header) header.style.display = "";
            if (saveBtnContainer) saveBtnContainer.style.display = "";
            if (exportBtnContainer) exportBtnContainer.style.display = "";
            footers.forEach((f) => (f.style.display = ""));
          });
      });
    </script>
  </body>
</html>
