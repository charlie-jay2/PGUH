<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel — NHS Staff Dashboard</title>
    <link rel="stylesheet" href="style.css" />
    <meta
      name="description"
      content="Prince Georges University Hospital — Official Roblox Prince Georges Hospital | Apart of the National Health Service"
    />

    <meta property="og:title" content="Prince Georges University Hospital" />
    <meta
      property="og:description"
      content="Official Roblox Prince Georges Hospital | Apart of the National Health Service"
    />
    <meta
      property="og:image"
      content="https://princegeorgesuniversityhospital.netlify.app/Assets/logo.png"
    />
    <meta property="og:type" content="website" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Prince Georges University Hospital" />
    <meta
      name="twitter:description"
      content="Official Roblox Prince Georges Hospital | Apart of the National Health Service"
    />
    <meta
      name="twitter:image"
      content="https://princegeorgesuniversityhospital.netlify.app/Assets/logo.png"
    />
  </head>
  <body>
    <header class="topbar">
      <img src="./Assets/logo.png" class="logo" />
      <div class="brand">Prince Georges University Hospital — Admin</div>
      <nav class="topnav">
        <a href="index.html">Home</a>
        <a href="cadmin.html">CAdmin</a>
        <a href="careers.html">Careers</a>
        <a href="staff.html">Staff</a>
      </nav>
      <div class="meta" id="metaArea"></div>
    </header>

    <main class="container" id="mainContainer">
      <section id="noAccess" class="hidden">
        <h2>Insufficient permissions</h2>
        <p>You do not have access to this page.</p>
      </section>

      <section
        id="adminPanel"
        class="hidden"
        style="display: flex; gap: 32px; flex-wrap: wrap"
      >
        <div
          id="usersSection"
          class="panel"
          style="flex: 1 1 400px; display: flex; flex-direction: column"
        >
          <h2 style="margin-top: 0; color: var(--nhs-blue); font-weight: 700">
            All Users
          </h2>
          <table
            class="table"
            id="usersTable"
            style="flex-grow: 1; min-height: 400px"
          >
            <thead>
              <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Role</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersBody"></tbody>
          </table>
        </div>

        <div
          id="createUserSection"
          class="panel"
          style="width: 350px; display: flex; flex-direction: column"
        >
          <h2 style="margin-top: 0; color: var(--nhs-blue); font-weight: 700">
            Create New User
          </h2>
          <form
            id="createUserForm"
            class="form"
            style="display: flex; flex-direction: column; gap: 16px"
          >
            <label>
              Username
              <input type="text" id="newUsername" required />
            </label>
            <label>
              Password
              <input type="password" id="newPassword" required />
            </label>
            <label>
              Role
              <select id="newRole" required>
                <option value="staff">Staff</option>
                <option value="admin">Admin</option>
              </select>
            </label>
            <label>
              Email
              <input type="email" id="newEmail" required />
            </label>
            <div
              class="form-actions"
              style="justify-content: flex-end; margin-top: 8px"
            >
              <button
                type="button"
                id="createUserBtn"
                style="
                  background-color: var(--nhs-blue);
                  color: white;
                  border: none;
                  padding: 12px 20px;
                  border-radius: var(--radius);
                  cursor: pointer;
                  font-weight: 700;
                  font-size: 1rem;
                  transition: background-color 0.3s ease;
                "
              >
                Create User
              </button>
            </div>
          </form>
        </div>

        <!-- SHIFT MANAGEMENT PANEL -->
        <div
          id="shiftsSection"
          class="panel"
          style="
            flex: 1 1 600px;
            display: flex;
            flex-direction: column;
            gap: 16px;
          "
        >
          <h2 style="margin-top: 0; color: var(--nhs-blue); font-weight: 700">
            Shift Management
          </h2>

          <form
            id="shiftForm"
            class="form"
            style="display: flex; flex-wrap: wrap; gap: 16px"
          >
            <label style="flex: 1 1 150px">
              Staff Name
              <input type="text" id="shiftStaffName" required />
            </label>

            <label style="flex: 1 1 150px">
              Role
              <input type="text" id="shiftRole" required />
            </label>

            <label style="flex: 1 1 200px">
              Shift Start
              <input type="datetime-local" id="shiftStart" required />
            </label>

            <label style="flex: 1 1 200px">
              Shift End
              <input type="datetime-local" id="shiftEnd" required />
            </label>

            <div
              style="flex: 1 1 100%; display: flex; justify-content: flex-end"
            >
              <button
                id="createShiftBtn"
                type="button"
                style="
                  background-color: var(--nhs-blue);
                  color: white;
                  border: none;
                  padding: 10px 18px;
                  border-radius: var(--radius);
                  cursor: pointer;
                  font-weight: 700;
                  font-size: 1rem;
                  transition: background-color 0.3s ease;
                "
              >
                Add Shift
              </button>
            </div>
          </form>

          <table
            id="shiftsTable"
            class="table"
            style="min-height: 300px; overflow-y: auto"
          >
            <thead>
              <tr>
                <th>Staff Name</th>
                <th>Role</th>
                <th>Shift Start</th>
                <th>Shift End</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="shiftsBody"></tbody>
          </table>
        </div>
      </section>
    </main>

    <footer class="footer">© 2025 Prince George University Hospital</footer>
    <script src="acknowledge.js"></script>
    <script src="email-helper.js"></script>

    <script>
      const token = localStorage.getItem("token");
      const apiBase = "/.netlify/functions";

      async function checkAccess() {
        if (!token) {
          document.getElementById("noAccess").classList.remove("hidden");
          return;
        }

        const res = await fetch(`${apiBase}/getUsers`, {
          headers: { Authorization: `Bearer ${token}` },
        });

        if (res.status === 403) {
          document.getElementById("noAccess").classList.remove("hidden");
          return;
        }

        const data = await res.json();
        document.getElementById("adminPanel").classList.remove("hidden");
        populateUsers(data.users);
        await loadShifts();
      }

      function populateUsers(users) {
        const body = document.getElementById("usersBody");
        body.innerHTML = "";
        users.forEach((u) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${escapeHtml(u.username)}</td>
            <td>${escapeHtml(u.email || "")}</td>
            <td>${escapeHtml(u.role)}</td>
            <td>
              <button onclick="resetPassword('${escapeJs(
                u.username
              )}', '${escapeJs(u.email || "")}')">Reset Password</button>
              <button onclick="deleteUser('${escapeJs(
                u.username
              )}', '${escapeJs(u.email || "")}')">Delete</button>
            </td>
          `;
          body.appendChild(tr);
        });
      }

      function escapeHtml(text) {
        return text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function escapeJs(text) {
        return text.replace(/'/g, "\\'");
      }

      async function resetPassword(username, email) {
        const newPass = prompt(`Enter new password for ${username}:`);
        if (!newPass) return;

        const res = await fetch(`${apiBase}/resetPassword`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ username, password: newPass, email }),
        });

        alert(await res.text());
      }

      async function deleteUser(username, email) {
        if (
          !confirm(
            `Are you sure you want to delete user '${username}'? This action cannot be undone.`
          )
        )
          return;

        const res = await fetch(`${apiBase}/deleteUser`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ username, email }),
        });

        const text = await res.text();
        alert(text);
        checkAccess();
      }

      document
        .getElementById("createUserBtn")
        .addEventListener("click", async () => {
          const username = document.getElementById("newUsername").value;
          const password = document.getElementById("newPassword").value;
          const role = document.getElementById("newRole").value;
          const email = document.getElementById("newEmail").value;

          const res = await fetch(`${apiBase}/createUser`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ username, password, role, email }),
          });

          alert(await res.text());
          checkAccess();
        });

      // SHIFT MANAGEMENT LOGIC

      // Load shifts and populate table
      async function loadShifts() {
        if (!token) return;
        try {
          const res = await fetch(`${apiBase}/getShifts`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!res.ok) throw new Error("Failed to load shifts");
          const data = await res.json();
          populateShifts(data.shifts);
        } catch (err) {
          console.error("Error loading shifts:", err);
        }
      }

      // Populate shifts table
      function populateShifts(shifts) {
        const tbody = document.getElementById("shiftsBody");
        tbody.innerHTML = "";
        shifts.forEach((shift) => {
          const tr = document.createElement("tr");
          tr.dataset.shiftId = shift._id;
          tr.dataset.shiftStart = shift.shiftStart;
          tr.dataset.shiftEnd = shift.shiftEnd;

          tr.innerHTML = `
            <td>${escapeHtml(shift.staffName)}</td>
            <td>${escapeHtml(shift.role)}</td>
            <td>${formatDateTime(shift.shiftStart)}</td>
            <td>${formatDateTime(shift.shiftEnd)}</td>
            <td class="shift-status">Loading...</td>
            <td><button onclick="deleteShift('${
              shift._id
            }')">Delete</button></td>
          `;

          tbody.appendChild(tr);
        });
        updateShiftStatuses();
      }

      // Format date/time nicely
      function formatDateTime(dateStr) {
        const d = new Date(dateStr);
        if (isNaN(d)) return "";
        return d.toLocaleString(undefined, {
          dateStyle: "short",
          timeStyle: "short",
        });
      }

      // Add new shift
      document
        .getElementById("createShiftBtn")
        .addEventListener("click", async () => {
          const staffName = document
            .getElementById("shiftStaffName")
            .value.trim();
          const role = document.getElementById("shiftRole").value.trim();
          const shiftStart = document.getElementById("shiftStart").value;
          const shiftEnd = document.getElementById("shiftEnd").value;

          if (!staffName || !role || !shiftStart || !shiftEnd) {
            alert("Please fill out all required fields.");
            return;
          }

          if (new Date(shiftStart) >= new Date(shiftEnd)) {
            alert("Shift End must be after Shift Start.");
            return;
          }

          try {
            const res = await fetch(`${apiBase}/createShift`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ staffName, role, shiftStart, shiftEnd }),
            });

            if (!res.ok) {
              const errorText = await res.text();
              throw new Error(errorText || "Failed to create shift");
            }

            alert("Shift created successfully!");
            document.getElementById("shiftForm").reset();
            loadShifts();
          } catch (err) {
            alert("Error creating shift: " + err.message);
          }
        });

      // Delete shift
      window.deleteShift = async function (shiftId) {
        if (!confirm("Are you sure you want to delete this shift?")) return;

        try {
          const res = await fetch(`${apiBase}/deleteShift`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ shiftId }),
          });

          if (!res.ok) throw new Error("Failed to delete shift");

          alert("Shift deleted.");
          loadShifts();
        } catch (err) {
          alert("Error deleting shift: " + err.message);
        }
      };

      // Update shift status badges
      function updateShiftStatuses() {
        const now = new Date();
        const rows = document.querySelectorAll("#shiftsBody tr");

        rows.forEach((row) => {
          const shiftStart = new Date(row.dataset.shiftStart);
          const shiftEnd = new Date(row.dataset.shiftEnd);
          const statusCell = row.querySelector(".shift-status");

          const diffToStart = (shiftStart - now) / (1000 * 60); // minutes
          const diffToEnd = (shiftEnd - now) / (1000 * 60);

          if (diffToStart <= 10 && diffToStart > 0) {
            statusCell.textContent = "Shift Starting Soon";
          } else if (diffToStart <= 0 && diffToEnd > 0) {
            statusCell.textContent = "Shift Started";
          } else if (diffToEnd <= 0) {
            statusCell.textContent = "Shift Ended";
          } else {
            statusCell.textContent = "Upcoming";
          }
        });
      }

      // Update shift statuses every minute
      setInterval(updateShiftStatuses, 60000);

      checkAccess();
    </script>
  </body>
</html>
